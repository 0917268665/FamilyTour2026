<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜‡é¾é“è‡ªé§•åŠ©æ‰‹ (éœæ…‹ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fafaf9; color: #44403c; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .active-tab { color: #1c1917; }
        .inactive-tab { color: #a8a29e; }
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="pb-24">

    <!-- Header -->
    <div class="bg-white border-b border-stone-200 sticky top-0 z-30 p-4 shadow-sm">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-stone-900">æ˜‡é¾é“è‡ªé§•åŠ©æ‰‹ ğŸš™</h1>
                <p class="text-xs text-stone-500 mt-1 font-medium italic">Travel Guide & Tools</p>
            </div>
            <div class="bg-stone-100 p-2 rounded-full">
                <i data-lucide="map" class="w-6 h-6 text-stone-600"></i>
            </div>
        </div>
        
        <!-- Day Selector (Only visible in Itinerary tab) -->
        <div id="day-selector-container" class="flex overflow-x-auto mt-4 gap-2 no-scrollbar pb-2 transition-all">
            <!-- Injected by JS -->
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="p-4 max-w-md mx-auto min-h-screen">
        <!-- Content injected by JS -->
    </div>

    <!-- Navigation Bar -->
    <div class="fixed bottom-6 left-4 right-4 bg-white/95 backdrop-blur border border-stone-200 p-3 flex justify-around items-center z-40 max-w-md mx-auto rounded-3xl shadow-2xl">
        <button onclick="switchTab('itinerary')" id="nav-itinerary" class="nav-btn flex flex-col items-center gap-1 active-tab">
            <i data-lucide="calendar" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold uppercase">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('hotels')" id="nav-hotels" class="nav-btn flex flex-col items-center gap-1 inactive-tab">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold uppercase">ä½å®¿</span>
        </button>
        <button onclick="switchTab('drive')" id="nav-drive" class="nav-btn flex flex-col items-center gap-1 inactive-tab">
            <i data-lucide="car" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold uppercase">è‡ªé§•</span>
        </button>
        <button onclick="switchTab('tools')" id="nav-tools" class="nav-btn flex flex-col items-center gap-1 inactive-tab">
            <i data-lucide="shopping-bag" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold uppercase">å·¥å…·</span>
        </button>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in" onclick="closeDetailModal()">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            <div class="bg-stone-900 text-white p-4 flex justify-between items-center">
                <h3 id="modal-title" class="font-bold text-lg flex items-center gap-2"><i data-lucide="book-open" class="w-5 h-5 text-amber-400"></i> æ™¯é»æ•…äº‹</h3>
                <button onclick="closeDetailModal()" class="p-1 rounded-full hover:bg-white/20"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <p id="modal-content" class="text-stone-700 leading-relaxed text-justify whitespace-pre-line text-sm"></p>
            </div>
            <div class="p-4 border-t border-stone-100 bg-stone-50 flex justify-end">
                <button onclick="speakContent()" class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-xl font-bold transition-all shadow-md active:scale-95">
                    <i data-lucide="volume-2" class="w-5 h-5"></i> æœ—è®€ä»‹ç´¹
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let activeTab = 'itinerary';
        let activeDay = 0;
        let checklist = JSON.parse(localStorage.getItem('trip_checks') || '{}');
        let budgetItems = JSON.parse(localStorage.getItem('trip_budget') || '[]');
        let batchItems = []; // æš«å­˜æ¹Šå–®é …ç›®
        let exchangeRate = 0.22; // é è¨­åŒ¯ç‡
        let currentModalText = ""; // ç”¨æ–¼æœ—è®€çš„æ–‡å­—

        // --- æ™¯é»æ·±åº¦ä»‹ç´¹è³‡æ–™åº« ---
        const ATTRACTION_DETAILS = {
            "æ˜¥ä¹‹é«˜å±±ç¥­ (å±±ç‹ç¥­)": "æ˜¥ä¹‹é«˜å±±ç¥­ï¼ˆSpring Takayama Festivalï¼‰ï¼Œåˆç¨±ç‚ºå±±ç‹ç¥­ï¼Œæ˜¯æ—¥æœ¬ä¸‰å¤§ç¾ç¥­ä¹‹ä¸€ï¼Œæ¯å¹´å›ºå®šæ–¼4æœˆ14æ—¥èˆ‡15æ—¥èˆ‰è¡Œï¼Œå®£å‘Šé£›é©’é«˜å±±æ˜¥å¤©çš„ä¾†è‡¨ã€‚\n\nã€ç¥­å…¸çœ‹é»ã€‘\n1. è¯éº—å±‹å°ï¼šç¥­å…¸çš„ä¸»è§’æ˜¯12åº§è¢«è­½ç‚ºã€Œæ´»å‹•çš„é™½æ˜é–€ã€çš„å±‹å°ï¼ˆèŠ±è»Šï¼‰ã€‚é€™äº›å±‹å°è£é£¾è‘—ç²¾ç·»çš„é£›é©’æœ¨é›•ã€æ¼†å™¨èˆ‡é‡‘å±¬é£¾å“ï¼Œå±•ç¾äº†æ±Ÿæˆ¶æ™‚ä»£å·¥åŒ çš„é«˜è¶…æŠ€è—ã€‚\n\n2. æ©Ÿé—œäººå¶è¡¨æ¼”ï¼šå…¶ä¸­å¹¾åº§å±‹å°ä¸Šæœ‰ç²¾å·§çš„ã€Œæ©Ÿé—œäººå¶ï¼ˆKarakuriï¼‰ã€ï¼Œç”±å¤šä½æ“å¶å¸«åœ¨å…§éƒ¨ç²¾å¯†æ“æ§ï¼Œäººå¶èƒ½åšå‡ºè®Šè‡‰ã€å¯«å­—ç­‰é«˜é›£åº¦å‹•ä½œï¼Œæ ©æ ©å¦‚ç”Ÿï¼Œæ˜¯å¿…çœ‹é‡é»ï¼\n\n3. å¤¢å¹»å¤œç¥­ï¼šè‹¥å¤©æ°£å…è¨±ï¼Œ14æ—¥æ™šä¸Šæœƒèˆ‰è¡Œå¤œç¥­ã€‚æ¯åº§å±‹å°æ›ä¸Šç´„100ç›ç‡ˆç± ï¼Œåœ¨æ¼†é»‘çš„å¤è€è¡—é“ä¸­å·¡éŠï¼Œèˆ‡ç™½å¤©è¯éº—ç‡¦çˆ›çš„æ°›åœæˆªç„¶ä¸åŒï¼Œå……æ»¿äº†å¤¢å¹»èˆ‡ç¥ç¥•æ„Ÿã€‚",
            
            "ç«‹å±±é»‘éƒ¨é›ªä¹‹å¤§è°·": "ç«‹å±±é»‘éƒ¨é˜¿çˆ¾å‘æ–¯è·¯ç·šï¼Œæ˜¯ä¸€æ¢é€£æ¥å¯Œå±±ç¸£èˆ‡é•·é‡ç¸£çš„å£¯é—Šå±±å²³è§€å…‰è·¯ç·šã€‚ç‚ºäº†ä¿è­·è‡ªç„¶ç’°å¢ƒï¼Œç§å®¶è»Šç¦æ­¢é€²å…¥ï¼Œæ—…å®¢å¿…é ˆæ›ä¹˜å¤šç¨®ç¨ç‰¹çš„äº¤é€šå·¥å…·æ‰èƒ½æ©«è¶Šç¾¤å±±ã€‚é€™è¶Ÿæ—…ç¨‹æ‚¨å°‡é«”é©—äººé¡å·¥ç¨‹èˆ‡å¤§è‡ªç„¶å¥‡æ™¯çš„çµåˆã€‚\n\nã€å…­ç¨®äº¤é€šå·¥å…·å¤§è§£å¯†ã€‘\n1. ç«‹å±±ç™»å±±çºœè»Š (7åˆ†é˜)ï¼šå¾ç«‹å±±ç«™ä¸€å£æ°£çˆ¬å‡500å…¬å°ºï¼Œé€²å…¥å±±å²³åœ°å¸¶ã€‚\n\n2. ç«‹å±±é«˜åŸå·´å£« (50åˆ†é˜)ï¼šè¡Œé§›åœ¨é›ªå£ä¹‹é–“ï¼Œå‰å¾€æ¨™é«˜2450å…¬å°ºçš„å®¤å ‚ï¼Œä¹Ÿå°±æ˜¯è‘—åçš„ã€Œé›ªä¹‹å¤§è°·ã€æ‰€åœ¨åœ°ã€‚\n\n3. ç«‹å±±éš§é“ç„¡è»Œé›»è»Š (10åˆ†é˜)ï¼šé€™æ˜¯åœ¨æ—¥æœ¬æµ·æ‹”æœ€é«˜çš„éš§é“ä¸­è¡Œé§›çš„é›»è»Šï¼Œå…¨ç¨‹éƒ½åœ¨å±±æ´è£¡ã€‚\n\n4. ç«‹å±±æ¶ç©ºç´¢é“ (7åˆ†é˜)ï¼šç„¡æ”¯æŸ±å¼çºœè»Šï¼Œåƒç§»å‹•çš„å±•æœ›å°ï¼Œå¯ä»¥360åº¦ä¿¯ç°é˜¿çˆ¾å‘æ–¯å±±è„ˆå…¨æ™¯ã€‚\n\n5. é»‘éƒ¨ç™»å±±çºœè»Š (5åˆ†é˜)ï¼šç‚ºäº†ä¸ç ´å£æ™¯è§€ï¼Œè¿™æ˜¯æ—¥æœ¬å”¯ä¸€å…¨åœ°ä¸‹å¼çš„çºœè»Šã€‚\n\n6. é—œé›»éš§é“é›»æ°£å·´å£« (16åˆ†é˜)ï¼šç©¿è¶Šç•¶å¹´å·¥ç¨‹æœ€è‰±é‰…çš„ç ´ç¢å¸¶ï¼Œæœ€å¾ŒæŠµé”æ‰‡æ¾¤ã€‚",
            
            "åèŠ±ä¹‹é‡Œ (Nabana no Sato)": "åèŠ±ä¹‹é‡Œï¼ˆNabana no Satoï¼‰ä½æ–¼ä¸‰é‡ç¸£æ¡‘åå¸‚ï¼Œä»¥ã€Œæ—¥æœ¬æœ€å¤§è¦æ¨¡çš„å¤œé–“ç‡ˆé£¾ã€èåæ–¼ä¸–ã€‚é€™è£¡çš„é»ç‡ˆæ´»å‹•ä¸åªæ˜¯å–®ç´”çš„æ›æ›ç‡ˆæ³¡ï¼Œè€Œæ˜¯åˆ©ç”¨æ•¸ç™¾è¬é¡†LEDç‡ˆçƒï¼Œåœ¨å¤§åœ°ä¸Šæç¹ªå‡ºå£¯è§€çš„åœ–ç•«ã€‚\n\nã€å¿…çœ‹äº®é»ã€‘\n1. å…‰ä¹‹éš§é“ï¼šå…¨é•·200å…¬å°ºçš„å…‰ä¹‹è¿´å»Šï¼Œèµ°åœ¨éš§é“ä¸­å½·å½¿è¢«æº«æš–çš„å…‰èŠ’åŒ…åœï¼Œæ˜¯é€™è£¡æœ€ç¶“å…¸çš„æ‰“å¡é»ã€‚\n\n2. ä¸»é¡Œç‡ˆé£¾å€ï¼šæ¯å¹´æœƒæœ‰ä¸åŒçš„ä¸»é¡Œï¼ˆå¦‚ç†Šæœ¬ç†Šã€é˜¿çˆ¾å‘æ–¯å±±çš„å°‘å¥³ç­‰ï¼‰ï¼Œåˆ©ç”¨ç‡ˆå…‰åœ¨å»£å¤§çš„æ–œå¡ä¸Šæ¼”å‡ºå‹•æ…‹çš„æ•…äº‹ã€‚\n\n3. æ°´ä¸Šç‡ˆé£¾ï¼šåˆ©ç”¨å¯¬å»£çš„æ°´é¢åå°„å…‰å½±ï¼Œå‰µé€ å‡ºå¦‚åŒæ¥µå…‰èˆ¬å¤¢å¹»çš„è‰²å½©è®ŠåŒ–ã€‚\n\nå»ºè­°æ‚¨å‚æ™šå…¥å ´ï¼Œå…ˆæ¬£è³ç™½å¤©çš„èŠ±åœ’ç¾æ™¯ï¼ˆå¦‚é¬±é‡‘é¦™ï¼‰ï¼Œéš¨è‘—å¤œå¹•ä½å‚ï¼Œè¦‹è­‰ç‡ˆå…‰ç¬é–“äº®èµ·çš„æ„Ÿå‹•æ™‚åˆ»ã€‚",
            
            "å‰åœåŠ›å…¬åœ’ Ghibli Park": "å‰åœåŠ›å…¬åœ’ä½æ–¼æ„›çŸ¥ç¸£ï¼Œæ˜¯å°‡åŸæœ¬çš„ã€Œæ„›ãƒ»åœ°çƒåšç´€å¿µå…¬åœ’ã€é‡æ–°è¦åŠƒï¼Œè®“å®®å´é§¿ç­†ä¸‹çš„å¥‡å¹»ä¸–ç•ŒçœŸå¯¦é‡ç¾ã€‚é€™è£¡èˆ‡ä¸€èˆ¬ä¸»é¡Œæ¨‚åœ’æœ€å¤§çš„ä¸åŒæ˜¯â€”â€”æ²’æœ‰å¤§å‹é›²éœ„é£›è»Šï¼Œæ²’æœ‰äººå¶è£è¡¨æ¼”ï¼Œä¸»æ‰“ã€Œæ•£æ­¥ã€ç™¼ç¾ã€æ„Ÿå—ã€ã€‚\n\nã€ä¸»è¦å€åŸŸã€‘\n1. å‰åœåŠ›å¤§å€‰åº«ï¼šé€™æ˜¯å®¤å…§å‹çš„å¤§å±•è¦½é¤¨ï¼Œæ”¶è—äº†å‰åœåŠ›ä½œå“çš„ç§˜å¯†ã€‚æ‚¨å¯ä»¥åœ¨é€™è£¡èˆ‡ã€Šç¥éš±å°‘å¥³ã€‹çš„ç„¡è‡‰ç”·åˆç…§ï¼Œæˆ–æ˜¯çœ‹åˆ°ã€Šå¤©ç©ºä¹‹åŸã€‹å·¨å¤§çš„æ©Ÿå™¨äººå…µã€‚\n\n2. é’æ˜¥ä¹‹ä¸˜ï¼šé‡ç¾äº†ã€Šå¿ƒä¹‹è°·ã€‹ä¸­çš„å¤è‘£åº—ã€Œåœ°çƒå±‹ã€ï¼Œç«™åœ¨é«˜è™•å¯ä»¥ä¿¯ç°åœ’å€ã€‚\n\n3. Dondokoä¹‹æ£®ï¼šä»¥ã€Šé¾è²“ã€‹ç‚ºä¸»é¡Œï¼Œç©¿éæ£®æ—æ­¥é“å¾Œï¼Œæœƒçœ‹åˆ°å°æœˆå’Œå°æ¢…çš„å®¶ã€‚\n\né€™è£¡çš„æ¯å€‹è§’è½éƒ½è—è‘—ç´°ç¯€ï¼Œè«‹æ”¾æ…¢è…³æ­¥ï¼Œåœ¨æ£®æ—èˆ‡å¾®é¢¨ä¸­å°‹æ‰¾å±¬æ–¼æ‚¨çš„ç«¥è©±å›æ†¶å§ï¼"
        };

        // --- è³‡æ–™æ•¸æ“š ---
        const itineraryData = [
            { 
                day: "Day 1", 
                date: "4/11 (å…­)", 
                location: "åå¤å±‹ Nagoya", 
                weather: "12Â°C - 18Â°C ğŸŒ¤ï¸", 
                events: [ 
                    { 
                        type: 'transport', 
                        title: 'å–è»Šï¼šæ—¥ç”£ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼', 
                        detail: 'ä¸­éƒ¨å›½éš›ç©ºæ¸¯åº— (Serena e-Power)', 
                        booking: '<a href="https://www.tabirai.net/car/search/UserLogin.aspx?YNO=123098386" target="_blank" class="underline decoration-indigo-300 hover:text-indigo-600">é ç´„è™Ÿ: 123098386 <i data-lucide="external-link" class="inline w-3 h-3"></i></a>', 
                        tips: 'å¯†ç¢¼: 17f23cd8 / ç¸½é¡: Â¥148,632 (ç¾å ´ä»˜)' 
                    }, 
                    { type: 'stay', title: 'Comfort Hotel Nagoya Shinkansenguchi', detail: 'åå¤å±‹è»Šç«™å¤ªé–£é€šå£', nav: 'Comfort Hotel Nagoya Shinkansenguchi', booking: 'CONF#80886535' }, 
                    { type: 'food', title: 'å¿…åƒï¼šæ‰‹ç¾½å…ˆ å±±é†¬', detail: 'èƒ¡æ¤’é¦™æ°£åè¶³çš„ç‚¸é›ç¿…', tips: 'å¿…é»ï¼šå¹»ä¹‹æ‰‹ç¾½å…ˆ' } 
                ] 
            },
            { 
                day: "Day 2", 
                date: "4/12 (æ—¥)", 
                location: "é«˜å±± Takayama", 
                weather: "8Â°C - 15Â°C â˜ï¸", 
                events: [ 
                    { type: 'transport', title: 'è‡ªé§•å‰å¾€é«˜å±±', detail: 'è·¯ç¨‹ç´„ 160km / 2.5å°æ™‚ã€‚ä¸­é€”å¯åœé£›é©’å¤å·ã€‚', tips: 'å»ºè­°åŠ è³¼ CEP é«˜é€Ÿå…¬è·¯ Pass' }, 
                    { type: 'attraction', title: 'é£›é©’å¤å· ç€¨æˆ¶å·é¯‰é­š', detail: 'ã€Šä½ çš„åå­—ã€‹å ´æ™¯å·¡ç¦®ï¼Œç™½å£åœŸè—è¡—æ•£ç­–ã€‚', nav: 'é£›é©’å¤å·ç™½å£åœŸè—è¡—' },
                    { type: 'stay', title: 'hotel around TAKAYAMA', detail: 'Ascend Hotel Collection', booking: 'CONF#78677355', nav: 'hotel around TAKAYAMA' }, 
                    { type: 'food', title: 'å¿…åƒï¼šä¸¸æ˜ é£›é©’ç‰›ç‡’è‚‰', detail: 'é«˜å±±åœ°å€æœ€çŸ¥åå’Œç‰›åº—', tips: 'å¿…é»ï¼šé£›é©’ç‰›ç››åˆ' } 
                ] 
            },
            { 
                day: "Day 3", 
                date: "4/13 (ä¸€)", 
                location: "å¥§é£›é©’ / é«˜å±±", 
                weather: "4Â°C - 12Â°C ğŸ”ï¸", 
                events: [ 
                    { type: 'attraction', title: 'æ–°ç©—é«˜é›™å±¤çºœè»Š', detail: 'æ¨™é«˜ 2156m å£¯é—Šé›ªå±±æ™¯', nav: 'æ–°ç©—é«˜çºœè»Š', highlight: 'å±±ä¸Šèˆ‡å±±ä¸‹æº«å·®å¤§ï¼Œå‚™åšå¤–å¥—' },
                    { type: 'food', title: 'å¹³æ¹¯æº«æ³‰', detail: 'å›ç¨‹å¯æ–¼å¹³æ¹¯æº«æ³‰ä¼‘æ¯æˆ–æ³¡è¶³æ¹¯', nav: 'å¹³æ¹¯æº«æ³‰' }, 
                    { type: 'stay', title: 'hotel around TAKAYAMA (çºŒä½)', detail: 'Ascend Hotel Collection', nav: 'hotel around TAKAYAMA' } 
                ] 
            },
            { 
                day: "Day 4", 
                date: "4/14 (äºŒ)", 
                location: "é«˜å±±ç¥­ (Day 1)", 
                weather: "7Â°C - 14Â°C ğŸŒ¸", 
                events: [ 
                    { type: 'attraction', title: 'æ˜¥ä¹‹é«˜å±±ç¥­ (å±±ç‹ç¥­)', detail: 'ã€å…¨æ—¥ã€‘æ¬£è³å±‹å°éŠè¡Œã€æ©Ÿé—œäººå¶è¡¨æ¼”ã€‚', highlight: 'é‡è¦ï¼šç¥­å…¸æœŸé–“å¸‚å€äº¤ç®¡ï¼Œè«‹æ­¥è¡Œå‰å¾€' }, 
                    { type: 'stay', title: 'hotel around TAKAYAMA (çºŒä½)', detail: 'Ascend Hotel Collection', nav: 'hotel around TAKAYAMA' } 
                ] 
            },
            { 
                day: "Day 5", 
                date: "4/15 (ä¸‰)", 
                location: "é«˜å±±ç¥­ â” å¯Œå±±", 
                weather: "10Â°C - 16Â°C ğŸš—", 
                events: [ 
                    { type: 'attraction', title: 'æ˜¥ä¹‹é«˜å±±ç¥­ (Day 2)', detail: 'ç¹¼çºŒåƒèˆ‡ç¥­å…¸æ´»å‹•è‡³ä¸‹åˆã€‚' }, 
                    { type: 'transport', title: 'å‰å¾€å¯Œå±±', detail: 'ç´„ 17:00 å‡ºç™¼ï¼Œè»Šç¨‹ç´„ 1.5 å°æ™‚ã€‚', tips: 'æ™šé¤å»ºè­°åœ¨å¯Œå±±è»Šç«™å‘¨é‚Šäº«ç”¨' },
                    { type: 'stay', title: 'Comfort Hotel Toyama', detail: 'å¯Œå±±è»Šç«™æ—', booking: 'CONF#80924504', nav: 'Comfort Hotel Toyama' } 
                ] 
            },
            { 
                day: "Day 6", 
                date: "4/16 (å››)", 
                location: "ç«‹å±±é»‘éƒ¨", 
                weather: "-2Â°C - 5Â°C â„ï¸", 
                events: [ 
                    { type: 'transport', title: 'è‡ªé§•è‡³ç«‹å±±ç«™', detail: 'ç§å®¶è»Šçµ‚é»ï¼Œè½‰ä¹˜ç™»å±±äº¤é€š', nav: 'ç«‹å±±ç«™' }, 
                    { type: 'attraction', title: 'ç«‹å±±é»‘éƒ¨é›ªä¹‹å¤§è°·', detail: 'é–‹å±±ç¬¬äºŒå¤©ï¼å£¯è§€é›ªç‰†', highlight: 'å¿…åšé ç´„ï¼šç«‹å±±ç™»å±±çºœè»Šé ç´„' }, 
                    { type: 'stay', title: 'Comfort Hotel Toyama (çºŒä½)', detail: 'å¯Œå±±è»Šç«™æ—', nav: 'Comfort Hotel Toyama' } 
                ] 
            },
            { 
                day: "Day 7", 
                date: "4/17 (äº”)", 
                location: "å¯Œå±± â” åå¤å±‹", 
                weather: "12Â°C - 19Â°C âœ¨", 
                events: [ 
                    { type: 'attraction', title: 'é›¨æ™´æµ·å²¸', detail: 'éš”è‘—æµ·çœºæœ›ç«‹å±±é€£å³° (å»ºè­°ä¸Šåˆå‰å¾€)', nav: 'é›¨æ™´æµ·å²¸' },
                    { type: 'transport', title: 'é–‹è»Šå—ä¸‹', detail: 'ç¶“æ±æµ·åŒ—é™¸é“å›åå¤å±‹ (ç´„3å°æ™‚)' },
                    { type: 'attraction', title: 'åèŠ±ä¹‹é‡Œ (Nabana no Sato)', detail: 'æ—¥æœ¬æœ€å¤§è¦æ¨¡å¤œé–“é»ç‡ˆ', nav: 'åèŠ±ä¹‹é‡Œ', highlight: 'ä¸‹åˆå››é»å‰å…¥å ´å¯å…ˆçœ‹èŠ±åœ’' }, 
                    { type: 'stay', title: 'Comfort Hotel Nagoya Fushimi', detail: 'åå¤å±‹å¸‚å€ä¼è¦‹ç«™', booking: 'CONF#80924952', nav: 'Comfort Hotel Nagoya Fushimi' } 
                ] 
            },
            { 
                day: "Day 8", 
                date: "4/18 (å…­)", 
                location: "é•·ä¹…æ‰‹ / å¸¸æ»‘", 
                weather: "13Â°C - 20Â°C ğŸ ", 
                events: [ 
                    { type: 'attraction', title: 'å‰åœåŠ›å…¬åœ’ Ghibli Park', detail: 'éœ€é ç´„ï¼Œé‡ç¾å®®å´é§¿ç¶“å…¸', nav: 'å‰åœåŠ›å…¬åœ’', highlight: 'é‡è¦é ç´„ä»£è™Ÿï¼šGHP-2026-XXXX' }, 
                    { type: 'stay', title: 'Comfort Hotel Central Int Airport', detail: 'æ©Ÿå ´åˆ†é¤¨', booking: 'CONF#80889756', nav: 'Comfort Hotel Central International Airport' } 
                ] 
            },
            { 
                day: "Day 9", 
                date: "4/19 (æ—¥)", 
                location: "æ©Ÿå ´è¿”å°", 
                weather: "15Â°C ğŸ›«", 
                events: [ 
                    { type: 'shopping', title: 'ä¸­éƒ¨æ©Ÿå ´æœ€å¾Œæ¡è²·', tips: 'å¿…è²·ï¼šãˆã³ã›ã‚“è²ã®é‡Œ è¦é¤…ã€èµ¤ç¦' }, 
                    { type: 'transport', title: 'é‚„è»Šï¼šæ—¥ç”£ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼', detail: 'ä¸­éƒ¨å›½éš›ç©ºæ¸¯åº— (Tel: 0569-38-1123)', tips: 'è«‹ä¿ç•™æœ€å¾Œä¸€æ¬¡åŠ æ»¿æ²¹çš„æ”¶æ“š' } 
                ] 
            }
        ];

        const TOOLS_DATA = {
            checklist: [
                { id: 'docs', name: 'é‡è¦æ–‡ä»¶', color: 'text-orange-600', bg: 'bg-orange-100', items: [ { id: 'check_doc_passport', label: 'è­·ç…§ (æª¢æŸ¥æ•ˆæœŸ)' }, { id: 'check_doc_money', label: 'æ—¥å¹£' }, { id: 'check_doc_vjw', label: 'ä¿¡ç”¨å¡' }, { id: 'check_doc_ticket', label: 'å€‹äººæ—…éŠä¿éšª' } ] },
                { id: 'tech', name: '3C ç”¢å“', color: 'text-blue-600', bg: 'bg-blue-100', items: [ { id: 'check_3c_phone', label: 'ç¶²å¡/æ¼«éŠ' }, { id: 'check_3c_charge', label: 'å……é›»å™¨/å……é›»ç·š' }, { id: 'check_3c_bank', label: 'è¡Œå‹•é›»æº' } ] },
                { id: 'personal', name: 'å€‹äºº/ç›¥æ´—', color: 'text-green-600', bg: 'bg-green-100', items: [ { id: 'check_item_rain', label: 'é›¨å…·/æ‘ºç–Šå‚˜' }, { id: 'check_item_coat', label: 'å¤–å¥—/ä¿æš–è¡£ç‰©' }, { id: 'check_item_wash', label: 'ç‰™åˆ·/æ´—é¢ä¹³' }, { id: 'check_item_meds', label: 'å€‹äººå¸¸å‚™è—¥' } ] }
            ],
            daily: [ { id: 'daily_charger', label: 'å……é›»å™¨ / è½‰æ¥é ­' }, { id: 'daily_wash', label: 'ç›¥æ´—åŒ… / çœ¼é¡' }, { id: 'daily_wifi', label: 'è­·ç…§ / éš¨èº«è²´é‡ç‰©å“' }, { id: 'daily_key', label: 'æˆ¿å¡å·²æ­¸é‚„' } ],
            jp: [
                { jp: 'ã™ã¿ã¾ã›ã‚“', romaji: 'Sumimasen', zh: 'ä¸å¥½æ„æ€' }, 
                { jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹', romaji: 'Toire wa?', zh: 'å»æ‰€åœ¨å“ªè£¡' },
                { jp: 'åˆ¥ã€…ã«åŒ…ã‚“ã§ãã ã•ã„', romaji: 'Betsu-betsu ni', zh: 'è«‹åˆ†é–‹åŒ…è£' }, 
                { jp: 'å…ç¨ã«ãªã‚Šã¾ã™ã‹', romaji: 'Tax Free?', zh: 'å¯ä»¥å…ç¨…å—?' },
                { jp: 'è¢‹ã¯è¦ã‚Šã¾ã›ã‚“', romaji: 'No Bag', zh: 'ä¸ç”¨è¢‹å­' }, 
                { jp: 'æ–°ã—ã„ã®ã¯ã‚ã‚Šã¾ã™ã‹', romaji: 'New one?', zh: 'æœ‰æ–°çš„å—?' },
                { jp: 'ã“ã‚Œã‚’ãã ã•ã„', romaji: 'Kore o kudasai', zh: 'æˆ‘è¦é€™å€‹' },
                { jp: 'ã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹', romaji: 'Card OK?', zh: 'å¯ä»¥åˆ·å¡å—?' },
                { jp: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãã ã•ã„', romaji: 'Menu Please', zh: 'è«‹çµ¦æˆ‘èœå–®' },
                { jp: 'ãŠæ°´ã‚’ãã ã•ã„', romaji: 'Water Please', zh: 'è«‹çµ¦æˆ‘æ°´' }, 
                { jp: 'ãŠã™ã™ã‚ã¯ï¼Ÿ', romaji: 'Recommend?', zh: 'æœ‰æ¨è–¦çš„å—?' },
                { jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', romaji: 'Check Bill', zh: 'éº»ç…©çµå¸³' }
            ]
        };

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchRate();
            renderApp();
            lucide.createIcons();
        });

        function fetchRate() {
            // ä½¿ç”¨å…è²»å…¬é–‹ API ç²å–åŒ¯ç‡ (ä¸éœ€ Key)
            fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                .then(res => res.json())
                .then(data => { if(data.rates.TWD) exchangeRate = data.rates.TWD; })
                .catch(e => console.log('Rate fetch error, using default', e));
        }

        // --- æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ ---
        function renderApp() {
            renderHeader();
            renderContent();
            renderNav();
            lucide.createIcons();
        }

        function switchTab(tab) {
            activeTab = tab;
            renderApp();
            window.scrollTo(0, 0);
        }

        function switchDay(idx) {
            activeDay = idx;
            renderApp();
        }

        // --- æ¸²æŸ“ Header ---
        function renderHeader() {
            const container = document.getElementById('day-selector-container');
            if (activeTab === 'itinerary') {
                container.classList.remove('hidden');
                container.innerHTML = itineraryData.map((d, idx) => `
                    <button onclick="switchDay(${idx})" 
                        class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-semibold transition-all ${activeDay === idx ? 'bg-stone-800 text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}">
                        ${d.day}
                    </button>
                `).join('');
            } else {
                container.classList.add('hidden');
                container.innerHTML = '';
            }
        }

        // --- æ¸²æŸ“ Navigation ---
        function renderNav() {
            ['itinerary', 'hotels', 'drive', 'tools'].forEach(tab => {
                const btn = document.getElementById(`nav-${tab}`);
                if (tab === activeTab) {
                    btn.classList.remove('inactive-tab');
                    btn.classList.add('active-tab', 'text-stone-900');
                } else {
                    btn.classList.remove('active-tab', 'text-stone-900');
                    btn.classList.add('inactive-tab', 'text-stone-400');
                }
            });
        }

        // --- æ¸²æŸ“ä¸»è¦å…§å®¹ (Switch) ---
        function renderContent() {
            const container = document.getElementById('main-content');
            
            if (activeTab === 'itinerary') {
                renderItineraryView(container);
            } else if (activeTab === 'hotels') {
                renderHotelsView(container);
            } else if (activeTab === 'drive') {
                renderDriveView(container);
            } else if (activeTab === 'tools') {
                renderToolsView(container);
            }
        }

        // 1. è¡Œç¨‹è¦–åœ– (åŠ å…¥æ™¯é»ä»‹ç´¹æŒ‰éˆ•)
        function renderItineraryView(container) {
            const dayData = itineraryData[activeDay];
            
            let html = `
                <div class="animate-in">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-stone-900">${dayData.location}</h2>
                            <p class="text-stone-500 flex items-center gap-1 mt-1 font-medium">
                                <i data-lucide="calendar" class="w-4 h-4"></i> ${dayData.date}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-stone-700">${dayData.weather}</p>
                            <p class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">Forecast</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${dayData.events.map((event, i) => `
                            <div class="bg-white rounded-2xl p-4 shadow-sm border border-stone-100">
                                <div class="flex gap-4">
                                    <div class="mt-1">${getIconHtml(event.type)}</div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h3 class="font-bold text-stone-800 leading-tight">${event.title}</h3>
                                            ${event.nav ? `<button onclick="openNav('${event.nav}')" class="p-1.5 bg-stone-50 rounded-lg text-stone-400 hover:text-stone-800"><i data-lucide="navigation" class="w-4 h-4"></i></button>` : ''}
                                        </div>
                                        <p class="text-sm text-stone-500 mt-1">${event.detail}</p>
                                        
                                        ${event.booking ? `<div class="mt-2 inline-flex items-center gap-1.5 bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded-md text-[10px] font-bold"><i data-lucide="ticket" class="w-3 h-3"></i> ${event.booking}</div>` : ''}
                                        ${event.tips ? `<div class="mt-2 text-xs text-stone-500 italic">ğŸ’¡ ${event.tips}</div>` : ''}
                                        ${event.highlight ? `<div class="mt-2 bg-rose-50 border-l-2 border-rose-300 p-2 text-xs font-bold text-rose-700">${event.highlight}</div>` : ''}
                                        
                                        <!-- æ™¯é»ä»‹ç´¹æŒ‰éˆ• -->
                                        ${ATTRACTION_DETAILS[event.title] ? `
                                            <button onclick="openDetailModal('${event.title}')" class="mt-3 flex items-center gap-2 bg-amber-100 text-amber-700 px-3 py-2 rounded-lg text-xs font-bold hover:bg-amber-200 transition-colors">
                                                <i data-lucide="book-open" class="w-4 h-4"></i> ğŸ“– æ™¯é»æ•…äº‹
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // 2. ä½å®¿è¦–åœ– (Filter out "(çºŒä½)")
        function renderHotelsView(container) {
            const hotels = itineraryData.flatMap(day => day.events.filter(e => e.type === 'stay' && !e.title.includes('(çºŒä½)')));
            container.innerHTML = `
                <div class="animate-in space-y-4">
                    <h2 class="text-2xl font-bold mb-4">é£¯åº—åŒ¯ç¸½ ğŸ¨</h2>
                    ${hotels.map(hotel => `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-stone-800">${hotel.title}</h3>
                                <p class="text-xs text-stone-500 mt-1">${hotel.detail}</p>
                                <div class="mt-2 text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded inline-block uppercase">
                                    ${hotel.booking}
                                </div>
                            </div>
                            <button onclick="openNav('${hotel.nav}')" class="bg-stone-800 text-white p-2 rounded-xl">
                                <i data-lucide="navigation" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 3. è‡ªé§•è¦–åœ–
        function renderDriveView(container) {
            container.innerHTML = `
                <div class="animate-in space-y-4">
                    <h2 class="text-2xl font-bold mb-4">è‡ªé§•å¿…çœ‹ ğŸš—</h2>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100 space-y-4">
                        <div class="flex gap-3">
                            <div class="bg-blue-50 p-2 rounded-lg"><i data-lucide="ticket" class="w-5 h-5 text-blue-600"></i></div>
                            <div>
                                <h4 class="font-bold text-sm">CEP / ETC å¡</h4>
                                <p class="text-xs text-stone-500 mt-1">å–è»Šæ™‚å‹™å¿…ç¢ºèªæ˜¯å¦å·²ç§Ÿå€Ÿ ETC å¡ä¸¦è©¢å• CEP åƒåˆ°é£½æ–¹æ¡ˆã€‚</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="bg-amber-50 p-2 rounded-lg"><i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i></div>
                            <div>
                                <h4 class="font-bold text-sm">ç«‹å±±é»‘éƒ¨åœè»Š (4/16)</h4>
                                <p class="text-xs text-stone-500 mt-1">è«‹å°èˆªè‡³ã€Œç«‹å±±ç«™ã€å¤§å‹å…è²»åœè»Šå ´ï¼Œå»ºè­°æ—©ä¸Š 7:00 å‰æŠµé”ä»¥å…å®¢æ»¿ã€‚</p>
                            </div>
                        </div>
                        <div class="flex gap-3 border-t pt-4">
                            <div class="bg-green-50 p-2 rounded-lg"><i data-lucide="navigation" class="w-5 h-5 text-green-600"></i></div>
                            <div>
                                <h4 class="font-bold text-sm">åŠ æ²¹æé†’</h4>
                                <p class="text-xs text-stone-500 mt-1">é‚„è»Šå‰éœ€è‡³æŒ‡å®šåŠ æ²¹ç«™åŠ æ»¿æ²¹ (Regular)ï¼Œä¸¦ä¿ç•™æ”¶æ“šä»¥ä¾›æŸ¥é©—ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 4. å·¥å…·è¦–åœ–
        function renderToolsView(container) {
            container.innerHTML = `
                <div class="animate-in space-y-6 pb-12">
                    <!-- æª¢æŸ¥æ¸…å–® -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100">
                        <h3 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="check-square" class="text-teal-500 w-5 h-5"></i> æ—…äººæª¢æŸ¥æ¸…å–®</h3>
                        <div class="space-y-4">
                            ${TOOLS_DATA.checklist.map(cat => `
                                <div>
                                    <p class="text-xs font-bold uppercase tracking-wider ${cat.bg} ${cat.color} px-2 py-1 rounded inline-block mb-2">${cat.name}</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${cat.items.map(item => `
                                            <button onclick="toggleCheck('${item.id}')" class="flex items-center gap-2 text-left p-2 rounded-lg border transition-all ${checklist[item.id] ? 'bg-stone-800 border-stone-800 text-white' : 'bg-white border-stone-200 text-stone-600'}">
                                                <div class="w-4 h-4 rounded border flex items-center justify-center ${checklist[item.id] ? 'border-white' : 'border-stone-300'}">
                                                    ${checklist[item.id] ? '<span class="text-xs">âœ“</span>' : ''}
                                                </div>
                                                <span class="text-xs font-medium">${item.label}</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                            <div class="pt-4 border-t border-stone-100">
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-xs font-bold uppercase text-stone-400">æ¯æ—¥é€€æˆ¿æª¢æŸ¥</p>
                                    <button onclick="resetDaily()" class="text-xs text-blue-500 underline">é‡ç½®</button>
                                </div>
                                <div class="space-y-2">
                                    ${TOOLS_DATA.daily.map(item => `
                                        <button onclick="toggleCheck('${item.id}')" class="w-full flex items-center gap-3 text-left p-2 rounded-lg border ${checklist[item.id] ? 'bg-stone-100 border-stone-300' : 'bg-white border-stone-200'}">
                                            <div class="w-5 h-5 rounded border flex items-center justify-center ${checklist[item.id] ? 'bg-stone-800 border-stone-800 text-white' : 'bg-white border-stone-300'}">
                                                ${checklist[item.id] ? '<span class="text-xs">âœ“</span>' : ''}
                                            </div>
                                            <span class="text-sm ${checklist[item.id] ? 'text-stone-400 line-through' : 'text-stone-700'}">${item.label}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ‰‹æŒ‡æ—¥èª -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100">
                        <h3 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="languages" class="text-green-500 w-5 h-5"></i> æ‰‹æŒ‡æ—¥èª (é»æ“Šç™¼éŸ³)</h3>
                        <div class="grid grid-cols-2 gap-2">
                            ${TOOLS_DATA.jp.map(p => `
                                <button onclick="speakJp('${p.jp}', '${p.romaji}')" class="p-3 bg-stone-50 rounded-xl text-left hover:bg-stone-100 active:scale-95 transition-all">
                                    <div class="text-[10px] text-stone-400">${p.zh}</div>
                                    <div class="font-bold text-stone-800 text-sm">${p.romaji}</div>
                                </button>
                            `).join('')}
                        </div>
                        <!-- ç©ºè€³å­—å¹•é¡¯ç¤ºå€ -->
                        <div id="speak-status" class="text-center text-xs text-stone-400 mt-3 h-4 font-medium transition-all"></div>
                    </div>

                    <!-- ç·Šæ€¥è¯çµ¡ -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100">
                        <h3 class="font-bold text-stone-800 mb-4 flex items-center gap-2"><i data-lucide="alert-triangle" class="text-red-500 w-5 h-5"></i> ç·Šæ€¥è¯çµ¡</h3>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <a href="tel:110" class="border border-stone-200 rounded-xl p-3 text-center bg-red-50">
                                <div class="text-xs text-red-400 mb-1 font-bold">è­¦å¯Ÿ POLICE</div>
                                <div class="text-2xl font-black text-red-600">110</div>
                            </a>
                            <a href="tel:119" class="border border-stone-200 rounded-xl p-3 text-center bg-red-50">
                                <div class="text-xs text-red-400 mb-1 font-bold">æ•‘è­· FIRE/AMB</div>
                                <div class="text-2xl font-black text-red-600">119</div>
                            </a>
                        </div>
                        <div class="p-3 bg-stone-50 rounded-xl flex justify-between items-center">
                            <div><p class="text-xs text-stone-400">è¨ªæ—¥å¤–åœ‹äººç†±ç·š (JNTO)</p><p class="font-bold text-sm">050-3816-2787</p></div>
                            <a href="tel:05038162787" class="bg-stone-200 text-stone-600 w-8 h-8 rounded-full flex items-center justify-center"><i data-lucide="phone" class="w-4 h-4"></i></a>
                        </div>
                    </div>

                    <!-- åŒ¯ç‡æ›ç®— -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100">
                        <h3 class="font-bold text-stone-800 mb-3 flex items-center gap-2"><i data-lucide="coins" class="text-yellow-500 w-5 h-5"></i> å³æ™‚åŒ¯ç‡</h3>
                        <div class="flex items-center gap-2 bg-stone-50 p-4 rounded-xl">
                            <div class="flex-1">
                                <label class="text-xs text-stone-400 block mb-1">æ—¥å¹£ (JPY)</label>
                                <input type="number" id="jpy-input" oninput="convertCurrency()" placeholder="è¼¸å…¥" class="w-full bg-transparent text-xl font-bold text-stone-800 outline-none" />
                            </div>
                            <div class="text-stone-300">âœ</div>
                            <div class="flex-1 text-right">
                                <label class="text-xs text-stone-400 block mb-1">å°å¹£ (TWD)</label>
                                <div id="twd-output" class="text-xl font-bold text-blue-500">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- å…ç¨…æ¹Šå–® -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-stone-800 flex items-center gap-2"><i data-lucide="calculator" class="text-pink-500 w-5 h-5"></i> å…ç¨…æ¹Šå–® (5500å††)</h3>
                            <button onclick="clearBatch()" class="text-xs text-red-400 underline">æ¸…ç©º</button>
                        </div>
                        <div class="bg-pink-50 p-4 rounded-xl border border-pink-100">
                            <div class="flex gap-2 mb-2">
                                <input id="batch-name" placeholder="å“å" class="flex-1 p-2 rounded text-xs outline-none">
                                <input id="batch-price" type="number" placeholder="Â¥å–®åƒ¹" class="w-20 p-2 rounded text-xs outline-none">
                                <button onclick="addBatchItem()" class="bg-pink-500 text-white px-3 rounded text-xs"><i data-lucide="plus" class="w-3 h-3"></i></button>
                            </div>
                            <div id="batch-list" class="bg-white/50 rounded-lg p-2 mb-3 max-h-32 overflow-y-auto hidden"></div>
                            
                            <div class="pt-2 border-t border-pink-200">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-stone-500">ç›®å‰ç¸½è¨ˆ</span>
                                    <span id="batch-total" class="font-bold text-pink-700">Â¥0</span>
                                </div>
                                <div class="w-full bg-pink-200 h-2 rounded-full mb-2 overflow-hidden">
                                    <div id="batch-progress" class="h-full bg-pink-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <p id="batch-status" class="text-center text-xs font-bold text-pink-600 mb-3">é‚„å·® Â¥5,500</p>
                            </div>
                        </div>
                    </div>

                    <!-- è³¼ç‰©è¨˜å¸³ -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-stone-800 flex items-center gap-2"><i data-lucide="shopping-bag" class="text-purple-500 w-5 h-5"></i> è³¼ç‰©è¨˜å¸³</h3>
                            <button onclick="clearBudget()" class="text-xs text-red-400 underline">æ¸…ç©º</button>
                        </div>
                        <div class="bg-stone-50 p-4 rounded-xl text-center mb-4">
                            <p class="text-xs text-stone-400">ç¸½èŠ±è²» (JPY)</p>
                            <p id="total-jpy" class="text-3xl font-black text-stone-800">Â¥0</p>
                            <p id="total-twd" class="text-xs text-stone-500 mt-1">ç´„å°å¹£ NT$ 0</p>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <input id="budget-name" placeholder="å“é …" class="flex-1 p-2 bg-stone-100 rounded-lg text-xs outline-none">
                            <input id="budget-price" type="number" placeholder="Â¥" class="w-20 p-2 bg-stone-100 rounded-lg text-xs outline-none">
                            <button onclick="addBudgetItem()" class="bg-stone-800 text-white px-3 rounded-lg"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                        <ul id="budget-list" class="space-y-2 max-h-60 overflow-y-auto"></ul>
                    </div>
                </div>
            `;
            
            // Re-render sub-components after injection
            renderBudgetList();
        }

        // --- è¼”åŠ©å‡½å¼ ---
        function getIconHtml(type) {
            const icons = {
                transport: '<i data-lucide="car" class="w-5 h-5 text-blue-500"></i>',
                food: '<i data-lucide="utensils" class="w-5 h-5 text-orange-500"></i>',
                stay: '<i data-lucide="home" class="w-5 h-5 text-indigo-500"></i>',
                shopping: '<i data-lucide="shopping-bag" class="w-5 h-5 text-pink-500"></i>',
                attraction: '<i data-lucide="map-pin" class="w-5 h-5 text-green-500"></i>'
            };
            return icons[type] || '<i data-lucide="info" class="w-5 h-5 text-gray-500"></i>';
        }

        function openNav(query) {
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        }

        function toggleCheck(id) {
            checklist[id] = !checklist[id];
            localStorage.setItem('trip_checks', JSON.stringify(checklist));
            renderContent(); // Re-render to show check status
            lucide.createIcons();
        }

        function resetDaily() {
            TOOLS_DATA.daily.forEach(i => delete checklist[i.id]);
            localStorage.setItem('trip_checks', JSON.stringify(checklist));
            renderContent();
            lucide.createIcons();
        }

        function speakJp(text, romaji) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ja-JP';
                u.rate = 0.9;
                
                // é¡¯ç¤ºç©ºè€³å­—å¹•
                const statusEl = document.getElementById('speak-status');
                if (statusEl) {
                    statusEl.innerText = `ğŸ”Š æ’­æ”¾ä¸­: ${romaji}`;
                    u.onend = function() { statusEl.innerText = ''; };
                }
                
                window.speechSynthesis.speak(u);
            } else {
                alert('æ‚¨çš„è£ç½®ä¸æ”¯æ´èªéŸ³æ’­æ”¾åŠŸèƒ½');
            }
        }

        // --- æ™¯é»ä»‹ç´¹ Modal é‚è¼¯ ---
        function openDetailModal(title) {
            const content = ATTRACTION_DETAILS[title];
            if (!content) return;
            
            currentModalText = content;
            document.getElementById('modal-title').innerHTML = `<i data-lucide="book-open" class="w-5 h-5 text-amber-400"></i> ${title}`;
            document.getElementById('modal-content').innerText = content;
            document.getElementById('detail-modal').classList.remove('hidden');
            lucide.createIcons(); // Refresh icons in modal
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            window.speechSynthesis.cancel(); // é—œé–‰è¦–çª—æ™‚åœæ­¢æœ—è®€
        }

        function speakContent() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Stop previous speech
                const u = new SpeechSynthesisUtterance(currentModalText);
                u.lang = 'zh-TW'; // è¨­å®šç‚ºä¸­æ–‡
                u.rate = 1.0;
                window.speechSynthesis.speak(u);
            } else {
                alert('æ‚¨çš„è£ç½®ä¸æ”¯æ´èªéŸ³æœ—è®€');
            }
        }

        // --- è¨˜å¸³ & åŒ¯ç‡ & æ¹Šå–®é‚è¼¯ ---
        function convertCurrency() {
            const val = document.getElementById('jpy-input').value;
            document.getElementById('twd-output').innerText = val ? Math.round(val * exchangeRate).toLocaleString() : 0;
        }

        function addBatchItem() {
            const name = document.getElementById('batch-name').value;
            const price = parseInt(document.getElementById('batch-price').value);
            if(name && price) {
                batchItems.push({name, price});
                document.getElementById('batch-name').value = '';
                document.getElementById('batch-price').value = '';
                renderBatch();
            }
        }

        function renderBatch() {
            const list = document.getElementById('batch-list');
            const total = batchItems.reduce((acc, i) => acc + i.price, 0);
            const remaining = 5500 - total;
            
            list.classList.remove('hidden');
            list.innerHTML = batchItems.map(i => `<div class="flex justify-between text-xs text-stone-600 mb-1"><span>${i.name}</span><span>Â¥${i.price}</span></div>`).join('');
            
            document.getElementById('batch-total').innerText = 'Â¥' + total.toLocaleString();
            const pct = Math.min((total / 5500) * 100, 100);
            const bar = document.getElementById('batch-progress');
            bar.style.width = pct + '%';
            bar.className = `h-full transition-all duration-500 ${total >= 5500 ? 'bg-green-500' : 'bg-pink-500'}`;
            
            const status = document.getElementById('batch-status');
            if(total >= 5500) {
                status.innerText = "âœ¨ å·²é”å…ç¨…é–€æª»ï¼";
                status.className = "text-center text-xs font-bold text-green-600 mb-3";
            } else {
                status.innerText = `é‚„å·® Â¥${remaining.toLocaleString()}`;
                status.className = "text-center text-xs font-bold text-pink-600 mb-3";
            }
        }

        function clearBatch() { batchItems = []; renderBatch(); document.getElementById('batch-list').classList.add('hidden'); }

        function addBudgetItem() {
            const name = document.getElementById('budget-name').value;
            const price = parseInt(document.getElementById('budget-price').value);
            if(name && price) {
                budgetItems.push({name, price});
                localStorage.setItem('trip_budget', JSON.stringify(budgetItems));
                document.getElementById('budget-name').value = '';
                document.getElementById('budget-price').value = '';
                renderBudgetList();
            }
        }

        function clearBudget() {
            if(confirm('ç¢ºå®šæ¸…ç©ºè¨˜å¸³ï¼Ÿ')) {
                budgetItems = [];
                localStorage.setItem('trip_budget', JSON.stringify(budgetItems));
                renderBudgetList();
            }
        }

        function renderBudgetList() {
            const list = document.getElementById('budget-list');
            if(!list) return;
            const total = budgetItems.reduce((acc, i) => acc + i.price, 0);
            
            document.getElementById('total-jpy').innerText = 'Â¥' + total.toLocaleString();
            document.getElementById('total-twd').innerText = 'ç´„å°å¹£ NT$ ' + Math.round(total * exchangeRate).toLocaleString();

            list.innerHTML = budgetItems.map((item, i) => `
                <li class="flex justify-between items-center border-b border-stone-100 pb-2 text-sm">
                    <span class="text-stone-600">${item.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-bold">Â¥${item.price.toLocaleString()}</span>
                        <button onclick="deleteBudgetItem(${i})" class="text-stone-300 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </li>
            `).join('');
            lucide.createIcons();
        }

        function deleteBudgetItem(idx) {
            budgetItems.splice(idx, 1);
            localStorage.setItem('trip_budget', JSON.stringify(budgetItems));
            renderBudgetList();
        }
    </script>
</body>
</html>